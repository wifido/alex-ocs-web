/*! ocs-web 2016-08-11 */
function showOrder(a){$("input[name='orderDetailNo']").val(a),$("#orderDetailModal").modal("show")}function showDeliveryEmp(a,b,c,d,e){$("input[name='modelEmpName']").val(a),$("input[name='empContact']").val(b),$("input[name='resourceId']").val(c),$("input[name='empOnTheWayOrder']").val(d),$("input[name='empCompletedOrder']").val(e),$("#empKpiAndOrderModal").modal("show")}define(["angular"],function(a){"use strict";return a.module("appCtrls.storeCtrls",[]).controller("storeManagerCtrl",["$scope","$state","$rootScope","$cookies","storeBiz","$ocsPopup",function(a,b,c,d,e,f){function g(){a.atWorkEmpNum=0,a.totalEmpNum=0,$("#storeOrderTable").bootstrapTable("removeAll"),e.getEmpListAndNum(a.storeCode).then(function(b){if(b.success){a.empList=b.object,a.atWorkEmpNum=a.empList.atWorkEmpNum,a.totalEmpNum=a.empList.totalEmpNum,a.deliveryEmps=a.empList.deliveryEmps;for(var c=0;c<a.deliveryEmps.length;c++)"驻店"===a.deliveryEmps[c].status&&a.deliveryEmps[c].lng&&a.deliveryEmps[c].lat&&(new AMap.Marker({map:a.map,position:[a.deliveryEmps[c].lng,a.deliveryEmps[c].lat],icon:new AMap.Icon({size:new AMap.Size(35,42),image:"/images/store_deliveryEmp.png",imageOffset:new AMap.Pixel(0,0)}),label:{content:'<div class="mapSan">'+a.deliveryEmps[c].name+"</div>",offset:new AMap.Pixel(2,(-22))}}),new AMap.Marker({map:a.map,offset:new AMap.Pixel((-20),11),position:[a.deliveryEmps[c].lng,a.deliveryEmps[c].lat],content:'<div ><span  class="amap-marker-label span3">'+a.deliveryEmps[c].onTheWayOrder+'</span><span class="amap-marker-label-red span3">'+a.deliveryEmps[c].completedOrder+"</span></div>"}));h(a.deliveryEmps)}else f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}function h(a){$("#storeOrderTable").bootstrapTable("load",{data:a})}a.storeCode={storeCode:c.authUser.shopCode},a.lng=c.authUser.lng,a.lat=c.authUser.lat,a.arrivalRate=0,a.backRate=0,a.orderTimeAvg=0,a.pickupTimeAvg=0,a.deliveryTimeAvg=0,a.deliveryInTimeRate=0,a.excptionDeliveryInTime=0,a.onTheWayOrder=0,a.completedOrder=0,a.map=new AMap.Map("mapContainer",{zoom:12,center:[a.lng,a.lat]}),AMap.plugin(["AMap.ToolBar","AMap.Scale"],function(){var b=new AMap.ToolBar,c=new AMap.Scale;a.map.addControl(b),a.map.addControl(c)}),new AMap.Marker({map:a.map,position:[a.lng,a.lat],icon:new AMap.Icon({size:new AMap.Size(40,50),image:"/images/store_location.png",imageOffset:new AMap.Pixel(0,0)})}),new AMap.Circle({map:a.map,center:new AMap.LngLat(a.lng,a.lat),radius:7e3,strokeColor:"#4199d0",strokeOpacity:1,strokeWeight:3,fillColor:"#4199d0",fillOpacity:.35}),$("#storeOrderTable").bootstrapTable({columns:[{field:"flag"},{field:"flag",formatter:function(a,b,c){return c+1}},{field:"storeName",formatter:function(a,b,d){return c.authUser.shopName}},{field:"name"},{field:"id"},{field:"contact"},{field:"type"},{field:"status"},{field:"orders",formatter:function(a,b,c){return"<span >"+b.onTheWayOrder+"/"+b.completedOrder+"</span>"}},{field:"currentOrders",formatter:function(a,b,c){var d="";if(null!==a)for(var e=0;e<a.length;e++)d+="<span style='cursor: pointer' class='text-blue' onclick='showOrder(\""+a[e]+"\")'>"+a[e]+"</span>",e!=a.length-1&&(d+="</br>");return d}},{field:"operation",formatter:function(a,b,c){return"<span style='cursor: pointer' onclick='showDeliveryEmp(\""+b.name+'","'+b.contact+'","'+b.resourceId+'","'+b.onTheWayOrder+'","'+b.completedOrder+"\")'  class='text-blue'>详情</span>"}}]}),g(),a.storeKpiQuery={storeCode:c.authUser.shopCode,type:c.authUser.userType},e.getStoreKpi(a.storeKpiQuery).then(function(b){b.success?(a.storeKpi=b.object,a.arrivalRate=a.storeKpi.arrivalRate,a.backRate=a.storeKpi.backRate,a.orderTimeAvg=a.storeKpi.orderTimeAvg,a.pickupTimeAvg=a.storeKpi.pickupTimeAvg,a.deliveryTimeAvg=a.storeKpi.deliveryTimeAvg,a.deliveryInTimeRate=a.storeKpi.deliveryInTimeRate,a.excptionDeliveryInTime=a.storeKpi.excptionDeliveryInTime,a.onTheWayOrder=a.storeKpi.onTheWayOrder,a.completedOrder=a.storeKpi.completedOrder):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})}),a.undistributedOrderNum=0,e.getUndistributedOrderNum(a.storeCode).then(function(b){b.success?a.undistributedOrderNum=b.object:f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})}),a.showUndistributedOrderList=function(){e.getUndistributedOrderList(a.storeCode).then(function(b){b.success?(null!=b.object&&(a.UndistributedOrderLis=b.object),$("#undistributedOrderListTable").bootstrapTable({data:a.UndistributedOrderLis,columns:[{field:"orderNo"},{field:"empName",formatter:function(a,b,c){return null==a?" ":a}},{field:"contact",formatter:function(a,b,c){return null==a?" ":a}},{field:"predictDate"}]}),$("#undistributedOrderListModal").modal("show")):f.growl(b.errorInfo,{type:"danger"})},function(a){$("#undistributedOrderListModal").modal("show"),f.growl(a.text,{type:"danger"})})},$("#empKpiAndOrderModal").on("shown.bs.modal",function(){a.empKpiAndOrderQuery={storeCode:c.authUser.shopCode,contact:$("input[name='empContact']").val(),resourceId:$("input[name='resourceId']").val()},a.empCompletedOrder=$("input[name='empCompletedOrder']").val(),a.empOnTheWayOrder=$("input[name='empOnTheWayOrder']").val(),$("#deliveryEmpOrderListTable").bootstrapTable({columns:[{field:"name",formatter:function(){return $("input[name='modelEmpName']").val()}},{field:"contact",formatter:function(){return $("input[name='empContact']").val()}},{field:"orderNo"},{field:"endTime",formatter:function(a){if(null==a||""==a)return null;var b=new Date(a),c=b.getFullYear()+"-",d=(b.getMonth()+1<10?"0"+(b.getMonth()+1):b.getMonth()+1)+"-",e=b.getDate()+" ",f=b.getHours()+":",g=b.getMinutes()+":",h=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();return c+d+e+f+g+h}},{field:"predictEndTime",formatter:function(a){var b=new Date(a),c=b.getFullYear()+"-",d=(b.getMonth()+1<10?"0"+(b.getMonth()+1):b.getMonth()+1)+"-",e=b.getDate()+" ",f=b.getHours()+":",g=b.getMinutes()+":",h=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();return c+d+e+f+g+h}},{field:"status"}]}),e.getDeliveryEmpKpiAndOrders(a.empKpiAndOrderQuery).then(function(b){b.success?(a.empKpiAndOrdersDto=b.object,a.empArrivalRate=a.empKpiAndOrdersDto.arrivalRate,a.empBackRate=a.empKpiAndOrdersDto.backRate,a.empDeliveryInTimeRate=a.empKpiAndOrdersDto.deliveryInTimeRate,a.empTaskInfos=a.empKpiAndOrdersDto.taskInfos,$("#deliveryEmpOrderListTable").bootstrapTable("load",{data:a.empTaskInfos})):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}),$("#orderDetailModal").on("shown.bs.modal",function(){a.orderNoQuery={orderNo:$("input[name='orderDetailNo']").val()},$("#orderDetailTable").bootstrapTable(),e.getOrderDetail(a.orderNoQuery).then(function(b){b.success?(a.orderDetailDto=b.object,$("#orderDetailTable").bootstrapTable("load",{data:a.orderDetailDto})):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}),a.doSearch=function(){a.empAndOrderQuery={orderNo:a.orderNo,empName:a.empName,storeCode:c.authUser.shopCode},e.getEmpListByOrderNoAndEmpName(a.empAndOrderQuery).then(function(b){b.success?(a.deliveryEmpDto=b.object,h(a.deliveryEmpDto)):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})},a.doDismiss=function(){a.orderNo="",a.empName="",g()},a.complaint=function(){return a.checkRow=$("#storeOrderTable").bootstrapTable("getAllSelections"),a.checkRow.length>1?void f.growl("一次只能投诉一名快递员哦~",{type:"danger"}):0==a.checkRow.length?void f.growl("请选择快递员!",{type:"danger"}):(a.empNameForComplain=a.checkRow[0].name,a.empIdForComplain=a.checkRow[0].id,a.complainReason=" ",$("#complaintModal").modal("show"),$("#complainReason")[0].focus(),void $("#complainReason").change())},a.doComplaint=function(){a.complaintQuery={storeCode:c.authUser.shopCode,storeName:c.authUser.shopName,resourceIds:a.checkRow[0].resourceId,empIds:a.checkRow[0].id,message:a.complainReason},e.doComplaint(a.complaintQuery).then(function(a){a.success?f.growl("投诉成功",{type:"success"}):f.growl(a.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})}),a.complainReason=" ",$("#complaintModal").modal("hide")},a.checkText=function(){a.complainReason.length>50?a.isShow=!0:a.isShow=!1},a.press=function(){if(a.checkRow=$("#storeOrderTable").bootstrapTable("getAllSelections"),0==a.checkRow.length)return void f.growl("请选择快递员!",{type:"danger"});for(var b=0;b<a.checkRow.length;b++)if(null==a.checkRow[b].currentOrders)return void f.growl("选择的快递员必须存在订单才可以进行催单哦!",{type:"danger"});$("#pressModal").modal("show")},a.doPress=function(){for(var b=0;b<a.checkRow.length;b++)a.pressOrderNos=a.checkRow[b].currentOrders,a.flag=b,a.urgeQuery={orderNos:a.pressOrderNos,resourceId:a.checkRow[b].resourceId},e.doPress(a.urgeQuery).then(function(b){b.success?(a.pressEmpSuccess=a.checkRow[a.flag].name+" ",a.tip="快递员: "+a.pressEmpSuccess+"催单成功",f.growl(a.tip,{type:"success"})):(a.pressEmpFailure=a.checkRow[a.flag].name+" ",a.tip="快递员: "+a.pressEmpFailure+"催单失败",f.growl(a.tip,{type:"danger"}))},function(b){a.pressEmpFailure=a.checkRow[a.flag].name+" ",a.tip="快递员: "+a.pressEmpFailure+"催单失败",f.growl(a.tip,{type:"danger"})});$("#pressModal").modal("hide")},a.applyForResource=function(){a.needPerson=0,$("#applyForResourceModal").modal("show")},a.doApplyForResource=function(){a.applyForResQuery={storeCode:c.authUser.shopCode,storeName:c.authUser.shopName,num:a.needPerson},e.doResApplication(a.applyForResQuery).then(function(a){a.success?f.growl("申请资源成功",{type:"success"}):f.growl(a.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})}),$("#applyForResourceModal").modal("hide")}}]).controller("merChantManagerCtrl",["$scope","$state","$rootScope","$cookies","storeBiz","$ocsPopup",function(a,b,c,d,e,f){function g(){a.storeKpiQuery={storeCode:a.storeCode,type:c.authUser.userType},e.getStoreKpi(a.storeKpiQuery).then(function(b){b.success?(a.storeKpi=b.object,a.arrivalRate=a.storeKpi.arrivalRate,a.backRate=a.storeKpi.backRate,a.orderTimeAvg=a.storeKpi.orderTimeAvg,a.pickupTimeAvg=a.storeKpi.pickupTimeAvg,a.deliveryTimeAvg=a.storeKpi.deliveryTimeAvg,a.deliveryInTimeRate=a.storeKpi.deliveryInTimeRate,a.excptionDeliveryInTime=a.storeKpi.excptionDeliveryInTime,a.onTheWayOrder=a.storeKpi.onTheWayOrder,a.completedOrder=a.storeKpi.completedOrder):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}function h(){a.empListQuery={storeCode:a.storeCode},$("#storeOrderTable").bootstrapTable("removeAll"),e.getEmpListAndNum(a.empListQuery).then(function(b){if(b.success){a.empList=b.object,a.atWorkEmpNum=a.empList.atWorkEmpNum,a.totalEmpNum=a.empList.totalEmpNum,a.deliveryEmps=a.empList.deliveryEmps;for(var c=0;c<a.deliveryEmps.length;c++)if("驻店"===a.deliveryEmps[c].status){new AMap.Marker({map:a.map,position:[a.deliveryEmps[c].lng,a.deliveryEmps[c].lat],icon:new AMap.Icon({size:new AMap.Size(48,48),image:"/images/store_deliveryEmp.png",imageOffset:new AMap.Pixel(0,0)}),label:{content:'<div class="mapSan">'+a.deliveryEmps[c].name+"</div>",offset:new AMap.Pixel(2,(-22))}});new AMap.Marker({map:a.map,offset:new AMap.Pixel((-20),11),position:[a.deliveryEmps[c].lng,a.deliveryEmps[c].lat],content:'<div ><span  class="amap-marker-label span3">'+a.deliveryEmps[c].onTheWayOrder+'</span><span class="amap-marker-label-red span3">'+a.deliveryEmps[c].completedOrder+"</span></div>"})}l(a.deliveryEmps)}else f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}function i(b){$("#provinceSelect").select2({data:b,placeholder:"请选择省",language:"zh-CN",minimumResultsForSearch:1/0,templateResult:function(a){return a.name},templateSelection:function(a){return a.name||a.text},escapeMarkup:function(a){return a}}).on("select2:select",function(b){$("#citySelect").empty(),$("#citySelect").append($("<option selected>"+a.title[1]+"</option>").val("")),$("#citySelect").trigger("change"),$("#storeSelect").empty(),$("#storeSelect").append($("<option selected>"+a.title[2]+"</option>").val("")),$("#storeSelect").trigger("change");var c=[];c.length=0;var d=$("#provinceSelect").val();a.cityList=[],a.cityList.length=0,a.cityList=a.objectList[d].cities;for(var e=0;e<a.cityList.length;e++){var f=a.cityList[e],g={id:e,name:f.cityName};c.push(g)}j(c)})}function j(b){$("#citySelect").select2({placeholder:"请选择市",language:"zh-CN",minimumResultsForSearch:1/0,data:b,templateResult:function(a){return a.name},templateSelection:function(a){return a.name||a.text},escapeMarkup:function(a){return a}}).on("select2:select",function(b){$("#storeSelect").empty(),$("#storeSelect").append($("<option selected>"+a.title[2]+"</option>").val("")),$("#storeSelect").trigger("change");var c=[];c.length=0;var d=$("#citySelect").val();a.storeList=a.cityList[d].stores;for(var e=0;e<a.storeList.length;e++){var f=a.storeList[e],g={id:e,name:f.storeName};c.push(g)}k(c)})}function k(b){$("#storeSelect").select2({placeholder:"请选择店铺",language:"zh-CN",minimumResultsForSearch:1/0,data:b,templateResult:function(a){return a.name},templateSelection:function(a){return a.name||a.text},escapeMarkup:function(a){return a}}).on("select2:select",function(b){var c=$("#storeSelect").val();a.pickStore=a.storeList[c],a.storeCode=a.pickStore.storeCode,a.storeName=a.pickStore.storeName,a.cityName=a.pickStore.cityName,a.lat=a.pickStore.lat,a.lng=a.pickStore.lng,a.cityCode=a.pickStore.cityCode,a.provinceCode=a.pickStore.provinceCode,a.provinceName=a.pickStore.provinceName,a.storeAddress=a.pickStore.storeAddress,a.map.setZoomAndCenter(12,[a.lng,a.lat]),m(),g(),h()})}function l(a){$("#storeOrderTable").bootstrapTable("load",{data:a})}function m(){a.map.clearMap(),new AMap.Marker({map:a.map,position:[a.lng,a.lat],icon:new AMap.Icon({size:new AMap.Size(40,50),image:"/images/store_location.png",imageOffset:new AMap.Pixel(0,0)})}),new AMap.Circle({map:a.map,center:new AMap.LngLat(a.lng,a.lat),radius:7e3,strokeColor:"#4199d0",strokeOpacity:1,strokeWeight:3,fillColor:"#4199d0",fillOpacity:.35})}a.merchantCode={merchantCode:c.authUser.shopCode},a.atWorkEmpNum=0,a.totalEmpNum=0,a.arrivalRate=0,a.backRate=0,a.orderTimeAvg=0,a.pickupTimeAvg=0,a.deliveryTimeAvg=0,a.deliveryInTimeRate=0,a.excptionDeliveryInTime=0,a.onTheWayOrder=0,a.completedOrder=0,a.map=new AMap.Map("mapContainer",{zoom:11}),AMap.plugin(["AMap.ToolBar","AMap.Scale"],function(){var b=new AMap.ToolBar,c=new AMap.Scale;a.map.addControl(b),a.map.addControl(c)}),a.title=["请选择省","请选择市","请选择店铺"],i(null),j(null),k(null),$("#storeOrderTable").bootstrapTable({columns:[{field:"cityName",formatter:function(){return a.cityName}},{field:"storeName",formatter:function(){return a.storeName}},{field:"name"},{field:"id"},{field:"contact"},{field:"type"},{field:"status"},{field:"orders",formatter:function(a,b,c){return"<span >"+b.onTheWayOrder+"/"+b.completedOrder+"</span>"}},{field:"operation",formatter:function(a,b,c){return"<span style='cursor: pointer' onclick='showDeliveryEmp(\""+b.name+'","'+b.contact+'","'+b.resourceId+'","'+b.onTheWayOrder+'","'+b.completedOrder+"\")' type='button' class='text-blue'>详情</span>"}}]}),e.getStoreLocation(a.merchantCode).then(function(b){if(b.success){a.objectList=b.object;for(var c=[],d=0;d<a.objectList.length;d++){var e=a.objectList[d],g={id:d,name:e.provinceName};c.push(g)}i(c)}else f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})}),$("#empKpiAndOrderModal").on("shown.bs.modal",function(){a.empKpiAndOrderQuery={storeCode:a.storeCode,contact:$("input[name='empContact']").val(),resourceId:$("input[name='resourceId']").val()},$("#deliveryEmpOrderListTable").bootstrapTable({columns:[{field:"name",formatter:function(){return $("input[name='modelEmpName']").val()}},{field:"contact",formatter:function(){return $("input[name='empContact']").val()}},{field:"orderNo"},{field:"endTime",formatter:function(a){if(null==a||""==a)return null;var b=new Date(a),c=b.getFullYear()+"-",d=(b.getMonth()+1<10?"0"+(b.getMonth()+1):b.getMonth()+1)+"-",e=b.getDate()+" ",f=b.getHours()+":",g=b.getMinutes()+":",h=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();return c+d+e+f+g+h}},{field:"predictEndTime",formatter:function(a){var b=new Date(a),c=b.getFullYear()+"-",d=(b.getMonth()+1<10?"0"+(b.getMonth()+1):b.getMonth()+1)+"-",e=b.getDate()+" ",f=b.getHours()+":",g=b.getMinutes()+":",h=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();return c+d+e+f+g+h}},{field:"status"}]}),a.empCompletedOrder=$("input[name='empCompletedOrder']").val(),a.empOnTheWayOrder=$("input[name='empOnTheWayOrder']").val(),e.getDeliveryEmpKpiAndOrders(a.empKpiAndOrderQuery).then(function(b){b.success?(a.empKpiAndOrdersDto=b.object,a.empArrivalRate=a.empKpiAndOrdersDto.arrivalRate,a.empBackRate=a.empKpiAndOrdersDto.backRate,a.empDeliveryInTimeRate=a.empKpiAndOrdersDto.deliveryInTimeRate,a.empTaskInfos=a.empKpiAndOrdersDto.taskInfos,$("#deliveryEmpOrderListTable").bootstrapTable("load",{data:a.empTaskInfos})):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})}),a.doSearch=function(){a.empAndOrderQuery={orderNo:a.orderNo,empName:a.empName,storeCode:a.storeCode},e.getEmpListByOrderNoAndEmpName(a.empAndOrderQuery).then(function(b){b.success?(a.deliveryEmpDto=b.object,l(a.deliveryEmpDto)):f.growl(b.errorInfo,{type:"danger"})},function(a){f.growl(a.text,{type:"danger"})})},a.doDismiss=function(){a.orderNo="",a.empName="",h()}}])});