/*! ocs-web 2016-09-26 */
define(["angular"],function(a){"use strict";return a.module("appCtrls.orderCtrls",[]).controller("orderListCtrl",["$scope","$rootScope","$state","$cookies","$interval","orderBiz","authBiz","CacheBiz","SystemConfig","$ocsPopup","FileSaver","Blob",function(b,c,d,e,f,g,h,i,j,k,l,m){$('[data-toggle="tooltip"]').tooltip(),b.totalCount=0,b.currentPage=1,b.pageCount=0,b.pageSize=10,b.receiveOrder={orderNo:"",receiveAddress:""},b.loading=!1,b.startDate=new Date,b.endDate=new Date,b.selector={availableOptions:[{id:"0",name:"全部"},{id:"1",name:"完成"},{id:"2",name:"异常"}],selectedOption:{id:"0",name:"全部"}},b.query={shopCode:"",contactMobile:"",orderStatus:"0",startDate:"",endDate:"",dateType:"",pageIndex:1,pageSize:b.pageSize};var n;b.orderListTable={id:"orderListTable",columns:[{field:"flag"},{field:"orderNo"},{field:"receivePhone"},{field:"receiveAddress"},{field:"paidAccount"},{field:"shopOrderDate"},{field:"vieBillDt"},{field:"takeItemDate"},{field:"signedDate"},{field:"orderStatus",class:"details-control",formatter:function(a,b,c){return'<a style="cursor:pointer;text-decoration:none;">'+a+"</a>"}}],clickRowCallback:function(a,c,d,e){if("orderStatus"==e)d.next().is("tr.detail-view")?$("#"+b.orderListTable.id).bootstrapTable("collapseRow",d.data("index")):$("#"+b.orderListTable.id).bootstrapTable("expandRow",d.data("index"));else if("modifyAddress"==e){if("1"!=c.orderErrorCode)return;b.receiveOrder.orderNo=c.orderNo,b.receiveOrder.receiveAddress=c.receiveAddress,k.confirm({id:"modifyAddressModal",templateUrl:"js/app/template/modifyAddress.html",scope:b}).then(function(a){a&&b.receiveOrder.orderNo&&b.receiveOrder.receiveAddress&&g.modifyOrderAddress({orderNo:b.receiveOrder.orderNo,newAddress:b.receiveOrder.receiveAddress}).then(function(a){a.success?(k.growl("修改成功,5秒后数据刷新",{type:"success"}),n&&f.cancel(n),b.loading=!0,n=f(function(){w(b.query)},5e3,1)):k.growl(a.errorInfo,{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})})}else if("cancelOrder"==e){if("1"!=c.cancelType)return;k.confirm({scope:b,content:"确认取消订单?"}).then(function(a){a&&g.cancelOrder({orderNo:c.shopOrderno}).then(function(a){a.success?(k.growl("取消成功,5秒后数据刷新",{type:"success"}),n&&f.cancel(n),b.loading=!0,n=f(function(){w(b.query)},5e3,1)):k.growl(a.errorInfo,{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})})}},expandRowCallback:function(a,b,c,d){var e=c.orderNo;g.getOrderDetail({orderNo:e}).then(function(a){if(a.success){var b=a.object;if(""==b)return;var c="",e=b.length;if(1==e)c=o+q+t(b[0])+" "+b[0].orderState+" "+u(b[0])+v(b[0])+r+p;else if(e>1){var f=o;$.each(b,function(a,b){a+1==e?f+=q+t(b)+" "+b.orderState+" "+u(b)+v(b):c=s+t(b)+" "+b.orderState+" "+u(b)+v(b)+r+c}),c=f+c,c+=p}d.html(c)}else k.growl("获取路由详情失败",{type:"danger"})},function(a){k.growl("获取路由详情失败",{type:"danger"})})},accessControlCallback:function(){h.isButtonAccessibleForUser(e.get("userRole"),"modifyAddress")&&(b.orderListTable.columns.push({field:"modifyAddress",class:"modify-operation",formatter:function(a,b,c){return"1"==b.orderErrorCode?"<span style='cursor: pointer' type='button' class='text-blue'>修改</span>":"<span type='button' class='text-dark'>不可修改</span>"}}),$("#"+b.orderListTable.id).find("tr").append('<th data-field="modifyAddress" data-align="center">地址修改</th>')),h.isButtonAccessibleForUser(e.get("userRole"),"cancelOrder")&&(b.orderListTable.columns.push({field:"cancelOrder",class:"cancel-operation",formatter:function(a,b,c){var d="";return"1"==b.cancelType?d="<span style='cursor: pointer' type='button' class='text-blue'>取消</span>":(d="<span type='button' class='text-dark'>不可取消</span>","已取消"==b.orderStatus&&(d="<span type='button' class='text-dark'>已取消</span>")),d}}),$("#"+b.orderListTable.id).find("tr").append('<th data-field="cancelOrder" data-align="center">订单取消</th>'))},templateUrl:"js/app/template/orderListTable.html"};var o='<div class="pull-right"> <ul class="timeline">',p="</ul> </div>",q=' <li> <i class="fa fa-o bg-red"></i> <div class="timeline-item"> <div class="timeline-body">',r="</div></div></li> ",s='<li> <i class="fa fa-o bg-gray"></i> <div class="timeline-item"> <div class="timeline-body">',t=function(a){var b="";return a.operateDate&&(b=a.operateDate),b},u=function(a){var b="";return a.deliveryEmpName&&a.deliveryEmpTel&&(b="（配送员："+a.deliveryEmpName+" "+a.deliveryEmpTel+"）"),b},v=function(a){var b="";return a.exceptionReason&&(b="（"+a.exceptionReason+"）"),b};b.search=function(){return b.query.pageIndex=1,b.currentPage=1,b.query.orderStatus=b.selector.selectedOption.id,b.startDate&&!b.endDate?void k.growl("请输入结束时间",{type:"danger"}):!b.startDate&&b.endDate?void k.growl("请输入开始时间",{type:"danger"}):(b.startDate&&(b.query.startDate=b.startDate.getTime(),b.currentPage=1),b.endDate&&(b.query.endDate=b.endDate.getTime()+864e5,b.currentPage=1),b.query.startDate&&b.query.endDate&&b.query.startDate>=b.query.endDate?void k.growl("开始时间不可大于结束时间",{type:"danger"}):void w(b.query))},b.print=function(){var c=$("#"+b.orderListTable.id).bootstrapTable("getAllSelections"),d=[],f=[];return $.each(c,function(a,b){f.push(c[a].orderNo)}),f.length<=0?void k.growl("请选择订单",{type:"danger"}):void g.getPrintOrderList({orderNos:f.toString()}).then(function(b){if(b.success){if(d=b.object,d.length<=0)return void k.growl("数据出错",{type:"danger"});for(var c=0;c<d.length;c++){if(!e.get("authUser"))return void k.growl("用户过期,请重新登陆",{type:"danger"});d[c].shopAddress=a.fromJson(e.get("authUser")).shopAddress}i.setCacheToSession(j.orderInfo,d),window.open(j.url_print)}else k.growl(b.errorInfo,{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})},b.next=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(b.currentPage==b.pageCount)return void k.growl("已经是最后一页",{type:"info"});b.currentPage++,b.query.pageIndex=b.currentPage,w(b.query)}},b.previous=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(1==b.currentPage)return void k.growl("已经是第一页",{type:"info"});b.currentPage--,b.query.pageIndex=b.currentPage,w(b.query)}},b.first=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(1==b.currentPage)return void k.growl("已经是第一页",{type:"info"});b.currentPage=1,b.query.pageIndex=b.currentPage,w(b.query)}},b.last=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(b.currentPage==b.pageCount)return void k.growl("已经是最后一页",{type:"info"});b.currentPage=b.pageCount,b.query.pageIndex=b.currentPage,w(b.query)}},b.orderList=[];var w=function(a){b.loading=!0,k.showLoading(!0,$("#"+b.orderListTable.id)),g.getOrderList(a).then(function(a){if(b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),a.success){b.totalCount=a.object.totalCount,0==b.totalCount&&(b.pageCount=0),b.totalCount?b.pageCount=Math.ceil(b.totalCount/b.pageSize):(b.totalCount=0,b.pageCount=0),b.orderList.length=0;for(var c=0;c<a.object.orderInfoList.length;c++)b.orderList.push(a.object.orderInfoList[c]);$("#"+b.orderListTable.id).bootstrapTable("load",{data:a.object.orderInfoList})}else k.growl(a.errorInfo,{type:"danger"})},function(a){b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),k.growl(a.text,{type:"danger"})})};b.query.dateType="",b.export=function(){if(b.query.orderStatus=b.selector.selectedOption.id,!b.startDate&&!b.endDate)return void k.growl("导出请输入下单日期范围",{type:"danger"});if(b.startDate&&!b.endDate)return void k.growl("请输入结束时间",{type:"danger"});if(!b.startDate&&b.endDate)return void k.growl("请输入开始时间",{type:"danger"});if(b.startDate&&(b.query.startDate=b.startDate.getTime()),b.endDate&&(b.query.endDate=b.endDate.getTime()+864e5),b.query.startDate&&b.query.endDate&&b.query.startDate>=b.query.endDate)return void k.growl("开始时间不可大于结束时间",{type:"danger"});var a=new Date(b.startDate);return a.setDate(a.getDate()+31),a<b.endDate?void k.growl("日期范围超过一个月，请缩短日期范围进行导出",{type:"danger"}):(b.loading=!0,k.showLoading(!0,$("#"+b.orderListTable.id)),void g.exportOrders(b.query).then(function(a){if(b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),a){var c=new m([a],{type:"application/x-xls"});l.saveAs(c,"订单列表.xls")}},function(a){b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),k.growl(a.text,{type:"danger"})}))}}]).controller("orderCreateCtrl",["$rootScope","$scope","$state","orderBiz","$ocsPopup","$cookies","SystemConfig","shopBiz","CacheBiz","ValidateBiz",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=new Date,c=b.getMonth()+1,d=b.getDate()+a;return c>=1&&c<=9&&(c="0"+c),d>=0&&d<=9&&(d="0"+d),b.getFullYear()+"-"+c+"-"+d}b.city=a.authUser.cityName,b.genOrderNo=a.authUser.shopCode+(new Date).getTime(),b.selector={availableOptions:[],selectedOption:{}},b.areaSelector={availableOptions:[],selectedOption:{}},b.timeTypeSelector={availableOptions:[{name:"今天",id:0},{name:"明天",id:1}],selectedOption:{name:"今天",id:0}},$("#dropdown-menu").on("click","li a",function(){$("#dropdownBtn").html($.trim(this.innerText)+" <span class='caret'></span>"),"立即配送"==$.trim(this.innerText)?$("#dropdownBtn").val("now"):$("#dropdownBtn").val($.trim(this.innerText))});var l=function(a,b,c){var d="<li role=‘presentation’ > <a role='menuitem' tabindex='-1' >";for(0==c?$("#dropdown-menu").append(d+"立即配送</a></li>"):$("#dropdown-menu").append(d+"00:00</a></li>");a<24;){if(b<=30){var e=a<10?"0"+a:a;$("#dropdown-menu").append(d+e+":30</a></li>")}if(23!=a){var e=a+1<10?"0"+(a+1):a+1;$("#dropdown-menu").append(d+e+":00</a></li>")}b=0,a++}};b.changeTimeType=function(a){0==a.id?($("#dropdownBtn").html("立即配送 <span class='caret'></span>"),$("#dropdownBtn").val("now"),$("#dropdown-menu").find("li").remove(),m()):1==a.id&&($("#dropdownBtn").html("00:00 <span class='caret'></span>"),$("#dropdownBtn").val("00:00"),$("#dropdown-menu").find("li").remove(),l(0,0,a.id))};var m=function(){d.getSystemDate().then(function(a){if(a.success){var b=new Date(a.object);l(b.getHours()+1,b.getMinutes(),0)}else l((new Date).getHours()+1,(new Date).getMinutes(),0)},function(a){l((new Date).getHours()+1,(new Date).getMinutes(),0)})};m(),b.templateDownload=g.url_template_download,b.query={orderNo:"",areaName:"",contactMobile:"",contactPerson:"",contactAddress:"",orderAmount:0,payMethod:"1",payStatus:1,productCategary:"",productCategaryName:"",productNum:1,weight:0,remark:"",expectDate:"",lon:"",lat:""};var n,o=function(){b.localtionBtn=!0;try{$("#orderCreateMapContainer").children().remove(),n=new AMap.Map("orderCreateMapContainer",{center:[a.authUser.lng,a.authUser.lat],zoom:12})}catch(a){$("#orderCreateMapContainer").parent().remove(),b.localtionBtn=!1,e.growl("地图初始化失败,请检查网络",{type:"danger",delay:1e3})}};b.gpsLocaltion=function(){var c=a.authUser.belongCityCode;if(!c)return void e.growl("城市代码不正确",{type:"danger",delay:1e3});if(!b.query.contactAddress)return void e.growl("请输入详细地址",{type:"danger",delay:1e3});try{AMap.service(["AMap.PlaceSearch"],function(){function a(c,f){"complete"===c&&"OK"===f.info&&e.autoRender({placeSearchInstance:d,panel:"panel",methodName:"search",methodArgumments:[b.query.contactAddress,a],data:f,map:n})}var d=new AMap.PlaceSearch({pageSize:5,pageIndex:1,city:c});d.search(b.query.contactAddress,a);var e=new Lib.AMap.PlaceSearchRender({finishCallback:function(a,c){var d=a.find(".amap-lib-infowindow-content").prev(".amap-lib-infowindow-title")[0].innerText;b.query.contactAddress=d.substr(2,d.indexOf("详情")-2).trim(),b.query.lon=c.location.lng,b.query.lat=c.location.lat,b.$apply()}})})}catch(a){e.growl("地图查询失败",{type:"danger",delay:1e3})}};var p=function(){!b.query.lon||!b.query.lat};b.$watch("query.contactMobile",function(b,c,f){b&&j.reg(4,b)&&d.getAddressBookList({mobile:b,shopCode:a.authUser.shopCode}).then(function(a){if(a.success){var c=a.object;if(c.length>0){for(var d=0;d<c.length;d++)if(b==c[d].contactMobile){f.query.contactPerson=c[d].contactName,f.query.contactAddress=c[d].contactAddress;break}}else console.log("result:"+a)}else console.log("result:"+a)},function(a){e.growl(a.text,{type:"danger",delay:500})}),b||(f.query.contactPerson="",f.query.contactAddress="")}),b.$watch("query.productNum",function(a,b,c){a<=0&&(e.growl("商品数量不能小于1",{type:"danger",delay:1e3}),c.query.productNum=1)}),b.initData=function(){h.shopAreas({cityCode:a.authUser.cityCode}).then(function(c){if(c.success&&c.object.length>0){for(var d=[],f=0;f<c.object.length;f++)d.push({id:f+1,name:c.object[f]});for(f=0;f<d.length;f++)if(d[f].name==a.authUser.areaName){b.areaSelector.selectedOption=d[f];break}b.areaSelector.availableOptions=d}else e.growl(c.errorInfo,{type:"danger"})},function(a){e.growl(a.text,{type:"danger"})}),h.shopProductType({storeCode:a.authUser.shopCode}).then(function(a){a.success&&a.object.length>0?(b.selector.availableOptions=a.object,b.selector.selectedOption=a.object[0]):a.object&&0!=a.object.length?e.growl(a.errorInfo,{type:"danger"}):e.growl("该商家没有商品类别",{type:"danger"})},function(a){e.growl(a.text,{type:"danger"})}),o()},b.payed=function(){b.query.payStatus=1,$("#payedBtn").css("background-color","#3c8dbc").css("color","white"),$("#nopayBtn").css("background-color","").css("color","black"),$("#codFee").val("0"),$("#codFee").attr("disabled","disabled")},b.nopay=function(){b.query.payStatus=2,$("#payedBtn").css("background-color","").css("color","black"),$("#nopayBtn").css("background-color","#3c8dbc").css("color","white"),$("#codFee").removeAttr("disabled")},b.inputNo=function(){b.genOrderNo="",$("#orderNo")[0].focus()},b.payed(),b.createOrder=function(){if(!b.genOrderNo)return e.growl("请输入订单号",{type:"danger"}),void $("#orderNo")[0].focus();var c=/^[A-Za-z0-9]+$/;if(!c.test(b.genOrderNo))return e.growl("请输入正确订单号格式(只能是字母或数字)",{type:"danger"}),void $("#orderNo")[0].focus();if(!b.query.contactMobile)return e.growl("请输入联系方式",{type:"danger"}),void $("#telephone")[0].focus();var f=/^1[3|4|5|7|8]\d{9}$/,g=/^\d{7,8}$/,h=b.query.contactMobile.length;if(7!=h&&8!=h&&11!=h)return e.growl("请输入正确的手机号码或电话",{type:"danger"}),void $("#telephone")[0].focus();if(11==h&&!f.test(b.query.contactMobile))return e.growl("请输入正确的手机号码",{type:"danger"}),void $("#telephone")[0].focus();if((7==h||8==h)&&!g.test(b.query.contactMobile))return e.growl("请输入正确的电话号码",{type:"danger"}),void $("#telephone")[0].focus();if(!b.query.contactPerson)return e.growl("请输入收货人",{type:"danger"}),void $("#linkman")[0].focus();if(!b.query.contactAddress)return e.growl("请输入详细地址",{type:"danger"}),void $("#contactAddress")[0].focus();if(2==b.query.payStatus&&0==b.query.orderAmount)return e.growl("请输入代收金额",{type:"danger"}),void $("#codFee")[0].focus();if(i=/^\d+(?=\.{0,1}\d+$|$)/,2==b.query.payStatus&&!i.test(b.query.orderAmount))return e.growl("请输入正确的金额数",{type:"danger"}),void $("#codFee")[0].focus();var i=/^[0-9]*[1-9][0-9]*$/;if(!i.test(b.query.productNum))return e.growl("请输入正确的数量",{type:"danger"}),void $("#quantity")[0].focus();if(b.query.weight||(b.query.weight=0),i=/^\d+(?=\.{0,1}\d+$|$)/,0!=b.query.weight&&"0"!=b.query.weight&&!i.test(b.query.weight))return e.growl("请输入正确的重量",{type:"danger"}),$("#weight")[0].focus(),void(b.query.weight=0);b.query.orderNo=b.genOrderNo,b.query.productCategary=b.selector.selectedOption.type,b.query.productCategaryName=b.selector.selectedOption.name,b.query.areaName=b.areaSelector.selectedOption.name;var j=$("#dropdownBtn").val();"now"!=$.trim(j)&&(b.query.expectDate=k(b.timeTypeSelector.selectedOption.id)+" "+j+":00"),p(),d.createOrder(b.query).then(function(c){c.success?(b.resetData(),e.growl("下单成功",{type:"success"})):e.growl(c.errorInfo,{type:"danger"}),b.genOrderNo=a.authUser.shopCode+(new Date).getTime()},function(c){e.growl(c.text,{type:"danger"}),b.genOrderNo=a.authUser.shopCode+(new Date).getTime()})},b.resetData=function(){b.query.contactAddress="",b.query.contactMobile="",b.query.contactPerson="",b.query.weight=0,b.query.remark="",b.query.orderAmount=0,b.payed(),b.query.productNum=1,b.genOrderNo=a.authUser.shopCode+(new Date).getTime(),o()},b.disable=!1,b.percent="0%",b.upload=function(a){if(null!=a){b.disable=!0;var c=new FormData;c.append("file",a),d.batchPlaceOrder(c).then(function(a){a.success?e.growl("批量导单成功! 成功:"+a.object.successNum+"单,失败:"+a.object.failNum+"单",{type:"success",delay:3e3}):a.object?(b.batchResult=a.object,b.successNum=b.batchResult.successNum,b.failNum=b.batchResult.failNum,b.failList=b.batchResult.failList,e.showModal({id:"batchOrderResultModal",templateUrl:"js/app/template/batchOrderResultModal.html",scope:b}).then(function(a){a&&$("#batchOrderResultTable").bootstrapTable({data:b.failList})})):e.growl(a.errorInfo?a.errorInfo:"上传失败,请检查格式",{type:"danger"}),b.disable=!1,b.percent="0%",b.file=null},function(a){b.file=null,b.disable=!1,b.percent="0%",e.growl("上传失败",{type:"danger"})},function(a){b.percent=parseInt(100*a.loaded/a.total)+"%"})}else e.growl("请选择上传的xls文件",{type:"danger"})}}]).controller("orderAuditCtrl",["$rootScope","$scope","$state","orderBiz","$ocsPopup","$cookies","SystemConfig","shopBiz","CacheBiz","ValidateBiz",function(a,b,c,d,e,f,g,h,i,j){b.totalCount=0,b.currentPage=1,b.pageCount=0,b.pageSize=10,b.startDate=new Date,b.endDate=new Date,b.query={receiveMobile:"",status:"0",startDate:"",endDate:"",page:0,pageSize:b.pageSize},b.selector={availableOptions:[{id:"0",name:"全部"},{id:"1",name:"未审核"},{id:"2",name:"取消"},{id:"3",name:"已审核"}],selectedOption:{id:"0",name:"全部"}},b.orderAuditTable={id:"orderAuditTable",columns:[{field:"flag"},{field:"sfOrderNo"},{field:"receiveMobile"},{field:"receiveAddress"},{field:"pickupMobile"},{field:"shopOrderNo"},{field:"createTime"},{field:"expectDate"},{field:"statusInfo"}],clickRowCallback:function(a,b,c,d){},expandRowCallback:function(a,b,c,d){},accessControlCallback:function(){b.orderAuditTable.columns.push({field:"modifyAddress",class:"modify-operation",formatter:function(a,b,c){return"1"==b.status?"<span style='cursor: pointer' type='button' class='text-blue'>修改</span>":"<span type='button' class='text-dark'>--</span>"}}),$("#"+b.orderAuditTable.id).find("tr").append('<th data-field="modifyAddress" data-align="center">地址修改</th>'),b.orderAuditTable.columns.push({field:"cancelOrder",class:"cancel-operation",formatter:function(a,b,c){var d="";return d="1"==b.status?"<span style='cursor: pointer' type='button' class='text-blue'>取消</span>":"<span type='button' class='text-dark'>--</span>"}}),$("#"+b.orderAuditTable.id).find("tr").append('<th data-field="cancelOrder" data-align="center">订单取消</th>')},templateUrl:"js/app/template/orderAuditTable.html"},b.search=function(){return b.query.page=0,b.currentPage=1,b.query.status=b.selector.selectedOption.id,b.startDate||b.endDate?b.startDate&&!b.endDate?void e.growl("请输入结束时间",{type:"danger"}):!b.startDate&&b.endDate?void e.growl("请输入开始时间",{type:"danger"}):(b.startDate&&(b.query.startDate=b.startDate.getTime(),b.currentPage=1),b.endDate&&(b.query.endDate=b.endDate.getTime()+864e5,b.currentPage=1),b.query.startDate&&b.query.endDate&&b.query.startDate>=b.query.endDate?void e.growl("开始时间不可大于结束时间",{type:"danger"}):void k(b.query)):void e.growl("请输入下单时间",{type:"danger"})};var k=function(a){b.loading=!0,e.showLoading(!0,$("#"+b.orderAuditTable.id)),d.getAuditOrderList(a).then(function(a){b.loading=!1,e.showLoading(!1,$("#"+b.orderAuditTable.id)),a.success?(b.totalCount=a.object.count,0==b.totalCount&&(b.pageCount=0),b.totalCount?b.pageCount=Math.ceil(b.totalCount/b.pageSize):(b.totalCount=0,b.pageCount=0),$("#"+b.orderAuditTable.id).bootstrapTable("load",{data:a.object.orders})):e.growl(a.errorInfo,{type:"danger"})},function(a){b.loading=!1,e.showLoading(!1,$("#"+b.orderAuditTable.id)),e.growl(a.text,{type:"danger"})})}}])});