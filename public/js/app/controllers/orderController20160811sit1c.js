/*! ocs-web 2016-08-11 */
define(["angular"],function(a){"use strict";return a.module("appCtrls.orderCtrls",[]).controller("orderListCtrl",["$scope","$rootScope","$state","$cookies","$interval","orderBiz","authBiz","CacheBiz","SystemConfig","$ocsPopup",function(b,c,d,e,f,g,h,i,j,k){$('[data-toggle="tooltip"]').tooltip(),b.totalCount=0,b.currentPage=1,b.pageCount=0,b.pageSize=10,b.receiveOrder={orderNo:"",receiveAddress:""},b.loading=!1,b.selector={availableOptions:[{id:"0",name:"全部"},{id:"1",name:"完成"},{id:"2",name:"异常"}],selectedOption:{id:"0",name:"全部"}},b.query={shopCode:"",contactMobile:"",orderStatus:"0",startDate:"",endDate:"",dateType:"",pageIndex:1,pageSize:b.pageSize};var l;b.orderListTable={id:"orderListTable",columns:[{field:"flag"},{field:"orderNo"},{field:"receivePhone"},{field:"receiveAddress"},{field:"paidAccount"},{field:"shopOrderDate"},{field:"vieBillDt"},{field:"takeItemDate"},{field:"signedDate"},{field:"orderStatus",class:"details-control",formatter:function(a,b,c){return'<a style="cursor:pointer;text-decoration:none;">'+a+"</a>"}}],clickRowCallback:function(a,c,d,e){if("orderStatus"==e)d.next().is("tr.detail-view")?$("#"+b.orderListTable.id).bootstrapTable("collapseRow",d.data("index")):$("#"+b.orderListTable.id).bootstrapTable("expandRow",d.data("index"));else if("modifyAddress"==e){if("1"!=c.orderErrorCode)return;b.receiveOrder.orderNo=c.orderNo,b.receiveOrder.receiveAddress=c.receiveAddress,k.confirm({id:"modifyAddressModal",templateUrl:"js/app/template/modifyAddress.html",scope:b}).then(function(a){a&&b.receiveOrder.orderNo&&b.receiveOrder.receiveAddress&&g.modifyOrderAddress({orderNo:b.receiveOrder.orderNo,newAddress:b.receiveOrder.receiveAddress}).then(function(a){a.success?(k.growl("修改成功,5秒后数据刷新",{type:"success"}),l&&f.cancel(l),b.loading=!0,l=f(function(){u(b.query)},5e3,1)):k.growl(a.errorInfo,{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})})}else if("cancelOrder"==e){if("1"!=c.cancelType)return;k.confirm({scope:b,content:"确认取消订单?"}).then(function(a){a&&g.cancelOrder({orderNo:c.shopOrderno}).then(function(a){a.success?(k.growl("取消成功,5秒后数据刷新",{type:"success"}),l&&f.cancel(l),b.loading=!0,l=f(function(){u(b.query)},5e3,1)):k.growl(a.errorInfo+",请稍后重试",{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})})}},expandRowCallback:function(a,b,c,d){var e=c.orderNo;g.getOrderDetail({orderNo:e}).then(function(a){if(a.success){var b=a.object;if(""==b)return;var c="",e=b.length;if(1==e)c=m+o+r(b[0])+" "+b[0].orderState+" "+s(b[0])+t(b[0])+p+n;else if(e>1){var f=m;$.each(b,function(a,b){a+1==e?f+=o+r(b)+" "+b.orderState+" "+s(b)+t(b):c=q+r(b)+" "+b.orderState+" "+s(b)+t(b)+p+c}),c=f+c,c+=n}d.html(c)}else k.growl("获取路由详情失败",{type:"danger"})},function(a){k.growl("获取路由详情失败",{type:"danger"})})},accessControlCallback:function(){h.isButtonAccessibleForUser(e.get("userRole"),"modifyAddress")&&(b.orderListTable.columns.push({field:"modifyAddress",class:"modify-operation",formatter:function(a,b,c){return"1"==b.orderErrorCode?"<span style='cursor: pointer' type='button' class='text-blue'>修改</span>":"<span type='button' class='text-dark'>不可修改</span>"}}),$("#"+b.orderListTable.id).find("tr").append('<th data-field="modifyAddress" data-align="center">地址修改</th>')),h.isButtonAccessibleForUser(e.get("userRole"),"cancelOrder")&&(b.orderListTable.columns.push({field:"cancelOrder",class:"cancel-operation",formatter:function(a,b,c){return"1"==b.cancelType?"<span style='cursor: pointer' type='button' class='text-blue'>取消</span>":"<span type='button' class='text-dark'>不可取消</span>"}}),$("#"+b.orderListTable.id).find("tr").append('<th data-field="cancelOrder" data-align="center">订单取消</th>'))},templateUrl:"js/app/template/orderListTable.html"};var m='<div class="pull-right"> <ul class="timeline">',n="</ul> </div>",o=' <li> <i class="fa fa-o bg-red"></i> <div class="timeline-item"> <div class="timeline-body">',p="</div></div></li> ",q='<li> <i class="fa fa-o bg-gray"></i> <div class="timeline-item"> <div class="timeline-body">',r=function(a){var b="";return a.operateDate&&(b=a.operateDate),b},s=function(a){var b="";return a.deliveryEmpName&&a.deliveryEmpTel&&(b="（配送员："+a.deliveryEmpName+" "+a.deliveryEmpTel+"）"),b},t=function(a){var b="";return a.exceptionReason&&(b="（"+a.exceptionReason+"）"),b};b.startDate="",b.endDate="",b.search=function(){return b.query.pageIndex=1,b.currentPage=1,b.query.orderStatus=b.selector.selectedOption.id,b.startDate&&!b.endDate?void k.growl("请输入结束时间",{type:"danger"}):!b.startDate&&b.endDate?void k.growl("请输入开始时间",{type:"danger"}):(b.startDate&&(b.query.startDate=b.startDate.getTime(),b.currentPage=1),b.endDate&&(b.query.endDate=b.endDate.getTime()+864e5,b.currentPage=1),b.query.startDate&&b.query.endDate&&b.query.startDate>=b.query.endDate?void k.growl("开始时间不可大于结束时间",{type:"danger"}):void u(b.query))},b.print=function(){var c=$("#"+b.orderListTable.id).bootstrapTable("getAllSelections"),d=[],f=[];return $.each(c,function(a,b){f.push(c[a].orderNo)}),f.length<=0?void k.growl("请选择订单",{type:"danger"}):void g.getPrintOrderList({orderNos:f.toString()}).then(function(b){if(b.success){if(d=b.object,d.length<=0)return void k.growl("数据出错",{type:"danger"});for(var c=0;c<d.length;c++){if(!e.get("authUser"))return void k.growl("用户过期,请重新登陆",{type:"danger"});d[c].shopAddress=a.fromJson(e.get("authUser")).shopAddress}i.setCache(j.orderInfo,d),window.open(j.url_print)}else k.growl(b.errorInfo,{type:"danger"})},function(a){k.growl(a.text,{type:"danger"})})},b.next=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(b.currentPage==b.pageCount)return void k.growl("已经是最后一页",{type:"info"});b.currentPage++,b.query.pageIndex=b.currentPage,u(b.query)}},b.previous=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(1==b.currentPage)return void k.growl("已经是第一页",{type:"info"});b.currentPage--,b.query.pageIndex=b.currentPage,u(b.query)}},b.first=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(1==b.currentPage)return void k.growl("已经是第一页",{type:"info"});b.currentPage=1,b.query.pageIndex=b.currentPage,u(b.query)}},b.last=function(){if(!b.loading){if(0==b.orderList.length)return void k.growl("请先查询",{type:"danger"});if(b.currentPage==b.pageCount)return void k.growl("已经是最后一页",{type:"info"});b.currentPage=b.pageCount,b.query.pageIndex=b.currentPage,u(b.query)}},b.orderList=[];var u=function(a){b.loading=!0,k.showLoading(!0,$("#"+b.orderListTable.id)),g.getOrderList(a).then(function(a){if(b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),a.success){b.totalCount=a.object.totalCount,0==b.totalCount&&(b.pageCount=0),b.totalCount?b.pageCount=Math.ceil(b.totalCount/b.pageSize):(b.totalCount=0,b.pageCount=0),b.orderList.length=0;for(var c=0;c<a.object.orderInfoList.length;c++)b.orderList.push(a.object.orderInfoList[c]);$("#"+b.orderListTable.id).bootstrapTable("load",{data:a.object.orderInfoList})}else k.growl(a.errorInfo,{type:"danger"})},function(a){b.loading=!1,k.showLoading(!1,$("#"+b.orderListTable.id)),k.growl(a.text,{type:"danger"})})};b.query.dateType=""}]).controller("orderCreateCtrl",["$rootScope","$scope","$state","orderBiz","$ocsPopup","$cookies","SystemConfig","shopBiz",function(a,b,c,d,e,f,g,h){b.city=a.authUser.cityName,b.genOrderNo=a.authUser.shopCode+(new Date).getTime(),b.selector={availableOptions:[],selectedOption:{}},b.areaSelector={availableOptions:[],selectedOption:{}},b.templateDownload=g.url_template_download,b.query={orderNo:"",areaName:"",contactMobile:"",contactPerson:"",contactAddress:"",orderAmount:0,payMethod:"1",payStatus:1,productCategary:"",productCategaryName:"",productNum:1,weight:0,remark:""},b.$watch("query.productNum",function(a,b,c){a<=0&&(e.growl("商品数量不能小于1",{type:"danger",delay:1e3}),c.query.productNum=1)}),b.initData=function(){h.shopAreas({cityCode:a.authUser.cityCode}).then(function(c){if(c.success&&c.object.length>0){for(var d=[],f=0;f<c.object.length;f++)d.push({id:f+1,name:c.object[f]});for(f=0;f<d.length;f++)if(d[f].name==a.authUser.areaName){b.areaSelector.selectedOption=d[f];break}b.areaSelector.availableOptions=d}else e.growl(c.errorInfo,{type:"danger"})},function(a){e.growl(a.text,{type:"danger"})}),h.shopProductType({storeCode:a.authUser.shopCode}).then(function(a){a.success&&a.object.length>0?(b.selector.availableOptions=a.object,b.selector.selectedOption=a.object[0]):0==a.object.length?e.growl("该商家没有商品类别",{type:"danger"}):e.growl(a.errorInfo,{type:"danger"})},function(a){e.growl(a.text,{type:"danger"})})},b.payed=function(){b.query.payStatus=1,$("#payedBtn").css("background-color","#3c8dbc").css("color","white"),$("#nopayBtn").css("background-color","").css("color","black"),$("#codFee").val("0"),$("#codFee").attr("disabled","disabled")},b.nopay=function(){b.query.payStatus=2,$("#payedBtn").css("background-color","").css("color","black"),$("#nopayBtn").css("background-color","#3c8dbc").css("color","white"),$("#codFee").removeAttr("disabled")},b.inputNo=function(){b.genOrderNo="",$("#orderNo")[0].focus()},b.payed(),b.createOrder=function(){if(!b.genOrderNo)return e.growl("请输入订单号",{type:"danger"}),void $("#orderNo")[0].focus();if(!b.query.contactMobile)return e.growl("请输入联系方式",{type:"danger"}),void $("#telephone")[0].focus();var c=/^1[3|4|5|7|8]\d{9}$/,f=/^\d{7,8}$/,g=b.query.contactMobile.length;if(7!=g&&8!=g&&11!=g)return e.growl("请输入正确的手机号码或电话",{type:"danger"}),void $("#telephone")[0].focus();if(11==g&&!c.test(b.query.contactMobile))return e.growl("请输入正确的手机号码",{type:"danger"}),void $("#telephone")[0].focus();if((7==g||8==g)&&!f.test(b.query.contactMobile))return e.growl("请输入正确的电话号码",{type:"danger"}),void $("#telephone")[0].focus();if(!b.query.contactPerson)return e.growl("请输入收货人",{type:"danger"}),void $("#linkman")[0].focus();if(!b.query.contactAddress)return e.growl("请输入详细地址",{type:"danger"}),void $("#contactAddress")[0].focus();if(2==b.query.payStatus&&0==b.query.orderAmount)return e.growl("请输入代收金额",{type:"danger"}),void $("#codFee")[0].focus();if(h=/^\d+(?=\.{0,1}\d+$|$)/,2==b.query.payStatus&&!h.test(b.query.orderAmount))return e.growl("请输入正确的金额数",{type:"danger"}),void $("#codFee")[0].focus();var h=/^[0-9]*[1-9][0-9]*$/;return h.test(b.query.productNum)?(b.query.weight||(b.query.weight=0),h=/^\d+(?=\.{0,1}\d+$|$)/,0==b.query.weight||"0"==b.query.weight||h.test(b.query.weight)?(b.query.orderNo=b.genOrderNo,b.query.productCategary=b.selector.selectedOption.type,b.query.productCategaryName=b.selector.selectedOption.name,b.query.areaName=b.areaSelector.selectedOption.name,void d.createOrder(b.query).then(function(c){c.success?(b.resetData(),e.growl("下单成功",{type:"success"})):e.growl(c.errorInfo,{type:"danger"}),b.genOrderNo=a.authUser.shopCode+(new Date).getTime()},function(c){e.growl(c.text,{type:"danger"}),b.genOrderNo=a.authUser.shopCode+(new Date).getTime()})):(e.growl("请输入正确的重量",{type:"danger"}),$("#weight")[0].focus(),void(b.query.weight=0))):(e.growl("请输入正确的数量",{type:"danger"}),void $("#quantity")[0].focus())},b.resetData=function(){b.query.contactAddress="",b.query.contactMobile="",b.query.contactPerson="",b.query.weight=0,b.query.remark="",b.query.orderAmount=0,b.payed(),b.query.productNum=1,b.genOrderNo=a.authUser.shopCode+(new Date).getTime()},b.disable=!1,b.percent="0%",b.upload=function(a){if(null!=a){b.disable=!0;var c=new FormData;c.append("file",a),d.batchPlaceOrder(c).then(function(a){a.success?e.growl("批量导单成功! 成功:"+a.object.successNum+"单,失败:"+a.object.failNum+"单",{type:"success",delay:3e3}):a.object?(b.batchResult=a.object,b.successNum=b.batchResult.successNum,b.failNum=b.batchResult.failNum,b.failList=b.batchResult.failList,e.showModal({id:"batchOrderResultModal",templateUrl:"js/app/template/batchOrderResultModal.html",scope:b}).then(function(a){a&&$("#batchOrderResultTable").bootstrapTable({data:b.failList})})):e.growl(a.errorInfo?a.errorInfo:"上传失败,请检查格式",{type:"danger"}),b.disable=!1,b.percent="0%",b.file=null},function(a){b.file=null,b.disable=!1,b.percent="0%",e.growl("上传失败",{type:"danger"})},function(a){b.percent=parseInt(100*a.loaded/a.total)+"%"})}else e.growl("请选择上传的xls文件",{type:"danger"})}}])});